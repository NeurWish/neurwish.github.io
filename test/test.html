<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Plane Detection with WebXR</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@1.0.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <script src="https://unpkg.com/aframe-arkit@0.2.0/dist/aframe-arkit.min.js"></script>
    <script>
        // WebXR AR session initialization
        AFRAME.registerComponent('ar-plane-detection', {
            init: function () {
                const sceneEl = this.el.sceneEl;
                const box = document.querySelector('#placeable-box');

                // Setup WebXR session
                sceneEl.renderer.xr.enabled = true;
                navigator.xr.requestSession('immersive-ar', {
                    requiredFeatures: ['hit-test'],
                    optionalFeatures: ['dom-overlay'],
                    domOverlay: { root: document.body }
                }).then(session => {
                    sceneEl.renderer.xr.setReferenceSpaceType('local');
                    sceneEl.renderer.xr.setSession(session);
                    
                    session.requestReferenceSpace('viewer').then(referenceSpace => {
                        session.requestHitTestSource({ space: referenceSpace }).then(hitTestSource => {
                            sceneEl.renderer.xr.setAnimationLoop(() => {
                                const frame = sceneEl.renderer.xr.getFrame();
                                const viewerPose = frame.getViewerPose(sceneEl.renderer.xr.getReferenceSpace());

                                if (viewerPose) {
                                    const hitTestResults = frame.getHitTestResults(hitTestSource);
                                    if (hitTestResults.length > 0) {
                                        const hit = hitTestResults[0];
                                        const hitPose = hit.getPose(sceneEl.renderer.xr.getReferenceSpace());
                                        box.setAttribute('position', `${hitPose.transform.position.x} ${hitPose.transform.position.y} ${hitPose.transform.position.z}`);
                                        box.setAttribute('visible', true); // 顯示可放置的物體
                                    }
                                }
                            });
                        });
                    });
                });
            }
        });
    </script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: black;
        }
    </style>
</head>
<body>
    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" ar-plane-detection>
        <a-camera rotation-reader></a-camera>

        <!-- 顯示的模型 -->
        <a-box id="placeable-box" position="0 0.5 0" color="#4CC3D2" visible="false"></a-box>
    </a-scene>
</body>
</html>
